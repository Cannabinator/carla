<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V2V Network Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        h1 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .status.connected {
            background: #4ade80;
            color: white;
        }
        
        .status.disconnected {
            background: #ef4444;
            color: white;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .card h2 {
            color: #667eea;
            font-size: 1.3em;
            margin-bottom: 15px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .stat {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .stat:last-child {
            border-bottom: none;
        }
        
        .stat-label {
            color: #6b7280;
            font-weight: 500;
        }
        
        .stat-value {
            color: #1f2937;
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .vehicle-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .vehicle-item {
            background: #f9fafb;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }
        
        .vehicle-id {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .vehicle-details {
            font-size: 0.9em;
            color: #6b7280;
        }
        
        .threat-high {
            border-left-color: #ef4444;
        }
        
        .threat-medium {
            border-left-color: #f59e0b;
        }
        
        .threat-low {
            border-left-color: #10b981;
        }
        
        .network-map {
            background: #f9fafb;
            border-radius: 8px;
            padding: 15px;
            min-height: 400px;
            position: relative;
            overflow: hidden;
        }
        
        .map-canvas {
            width: 100%;
            height: 400px;
            background: #1f2937;
            border-radius: 6px;
        }
        
        .threat-alert {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
        }
        
        .threat-alert strong {
            color: #991b1b;
        }
        
        .update-time {
            color: #9ca3af;
            font-size: 0.85em;
            margin-top: 10px;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .loading {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üöó V2V Network Dashboard</h1>
            <p style="margin: 10px 0;">Real-time Vehicle-to-Vehicle Communication Monitor</p>
            <span class="status disconnected" id="status">Connecting...</span>
            <span class="update-time" id="lastUpdate">Last update: Never</span>
        </header>
        
        <div class="grid">
            <!-- Network Statistics -->
            <div class="card">
                <h2>üìä Network Statistics</h2>
                <div class="stat">
                    <span class="stat-label">Total Vehicles</span>
                    <span class="stat-value" id="totalVehicles">-</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Messages Sent</span>
                    <span class="stat-value" id="messagesSent">-</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Avg Neighbors</span>
                    <span class="stat-value" id="avgNeighbors">-</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Max Neighbors</span>
                    <span class="stat-value" id="maxNeighbors">-</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Update Rate</span>
                    <span class="stat-value" id="updateRate">-</span>
                </div>
                <div class="stat">
                    <span class="stat-label">V2V Range</span>
                    <span class="stat-value" id="v2vRange">-</span>
                </div>
            </div>
            
            <!-- Ego Vehicle Info -->
            <div class="card">
                <h2>üëë Ego Vehicle (ID: 0)</h2>
                <div class="stat">
                    <span class="stat-label">Speed</span>
                    <span class="stat-value" id="egoSpeed">-</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Heading</span>
                    <span class="stat-value" id="egoHeading">-</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Position</span>
                    <span class="stat-value" id="egoPosition">-</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Acceleration</span>
                    <span class="stat-value" id="egoAccel">-</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Neighbors</span>
                    <span class="stat-value" id="egoNeighbors">-</span>
                </div>
            </div>
            
            <!-- Threat Assessment -->
            <div class="card">
                <h2>‚ö†Ô∏è Threat Assessment</h2>
                <div id="threatList" class="vehicle-list">
                    <p style="color: #9ca3af; text-align: center;">No threats detected</p>
                </div>
            </div>
        </div>
        
        <!-- Nearby Vehicles -->
        <div class="card" style="margin-bottom: 20px;">
            <h2>üì° Nearby Vehicles</h2>
            <div id="neighborList" class="vehicle-list">
                <p style="color: #9ca3af; text-align: center;">No nearby vehicles</p>
            </div>
        </div>
        
        <!-- Network Visualization -->
        <div class="card">
            <h2>üó∫Ô∏è Network Map</h2>
            <div class="network-map">
                <canvas id="mapCanvas" class="map-canvas"></canvas>
            </div>
        </div>
    </div>
    
    <script>
        let ws = null;
        let reconnectInterval = null;
        
        // DOM elements
        const statusEl = document.getElementById('status');
        const lastUpdateEl = document.getElementById('lastUpdate');
        
        // Connect to WebSocket
        function connect() {
            const wsUrl = `ws://${window.location.hostname}:8001/ws/v2v`;
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                console.log('Connected to V2V WebSocket');
                statusEl.textContent = 'Connected';
                statusEl.className = 'status connected';
                if (reconnectInterval) {
                    clearInterval(reconnectInterval);
                    reconnectInterval = null;
                }
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                updateDashboard(data);
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                statusEl.textContent = 'Error';
                statusEl.className = 'status disconnected';
            };
            
            ws.onclose = () => {
                console.log('Disconnected from V2V WebSocket');
                statusEl.textContent = 'Disconnected';
                statusEl.className = 'status disconnected';
                
                // Try to reconnect
                if (!reconnectInterval) {
                    reconnectInterval = setInterval(() => {
                        console.log('Attempting to reconnect...');
                        connect();
                    }, 3000);
                }
            };
        }
        
        // Fetch network stats via REST API
        async function fetchNetworkStats() {
            try {
                const response = await fetch(`http://${window.location.hostname}:8001/network/stats`);
                const stats = await response.json();
                
                document.getElementById('totalVehicles').textContent = stats.total_vehicles;
                document.getElementById('messagesSent').textContent = stats.total_messages_sent.toLocaleString();
                document.getElementById('avgNeighbors').textContent = stats.average_neighbors.toFixed(1);
                document.getElementById('maxNeighbors').textContent = stats.max_neighbors;
                document.getElementById('updateRate').textContent = `${stats.update_rate_hz} Hz`;
                document.getElementById('v2vRange').textContent = `${stats.max_range_m} m`;
            } catch (error) {
                console.error('Failed to fetch network stats:', error);
            }
        }
        
        // Fetch neighbors for ego vehicle
        async function fetchNeighbors() {
            try {
                const response = await fetch(`http://${window.location.hostname}:8001/vehicles/0/neighbors`);
                const neighbors = await response.json();
                
                const neighborList = document.getElementById('neighborList');
                document.getElementById('egoNeighbors').textContent = neighbors.length;
                
                if (neighbors.length === 0) {
                    neighborList.innerHTML = '<p style="color: #9ca3af; text-align: center;">No nearby vehicles</p>';
                    return;
                }
                
                neighborList.innerHTML = neighbors.map(n => `
                    <div class="vehicle-item">
                        <div class="vehicle-id">Vehicle ${n.vehicle_id}</div>
                        <div class="vehicle-details">
                            Distance: ${n.distance.toFixed(1)} m | 
                            Speed: ${n.bsm.speed.toFixed(1)} km/h |
                            Heading: ${n.bsm.heading.toFixed(0)}¬∞
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to fetch neighbors:', error);
            }
        }
        
        // Fetch threats for ego vehicle
        async function fetchThreats() {
            try {
                const response = await fetch(`http://${window.location.hostname}:8001/vehicles/0/threats`);
                const threats = await response.json();
                
                const threatList = document.getElementById('threatList');
                
                if (threats.length === 0) {
                    threatList.innerHTML = '<p style="color: #9ca3af; text-align: center;">No threats detected</p>';
                    return;
                }
                
                threatList.innerHTML = threats.map(t => {
                    const level = t.threat_level >= 3 ? 'high' : t.threat_level >= 2 ? 'medium' : 'low';
                    return `
                        <div class="vehicle-item threat-${level}">
                            <div class="vehicle-id">‚ö†Ô∏è Vehicle ${t.other_vehicle_id} - Level ${t.threat_level}</div>
                            <div class="vehicle-details">
                                TTC: ${t.time_to_collision.toFixed(1)} s | 
                                Distance: ${t.distance.toFixed(1)} m
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Failed to fetch threats:', error);
            }
        }
        
        // Update ego vehicle info
        async function updateEgoInfo() {
            try {
                const response = await fetch(`http://${window.location.hostname}:8001/vehicles/0`);
                const bsm = await response.json();
                
                document.getElementById('egoSpeed').textContent = `${bsm.speed.toFixed(1)} km/h`;
                document.getElementById('egoHeading').textContent = `${bsm.heading.toFixed(0)}¬∞`;
                document.getElementById('egoPosition').textContent = 
                    `(${bsm.position.x.toFixed(0)}, ${bsm.position.y.toFixed(0)})`;
                document.getElementById('egoAccel').textContent = 
                    `${bsm.acceleration.longitudinal.toFixed(2)} m/s¬≤`;
            } catch (error) {
                console.error('Failed to fetch ego info:', error);
            }
        }
        
        // Update dashboard
        function updateDashboard(data) {
            lastUpdateEl.textContent = `Last update: ${new Date().toLocaleTimeString()}`;
            
            // Update all data
            fetchNetworkStats();
            updateEgoInfo();
            fetchNeighbors();
            fetchThreats();
            
            // Draw network map
            drawNetworkMap(data.bsm_messages || []);
        }
        
        // Draw network visualization
        function drawNetworkMap(vehicles) {
            const canvas = document.getElementById('mapCanvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            // Clear canvas
            ctx.fillStyle = '#1f2937';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            if (vehicles.length === 0) return;
            
            // Find bounds
            const positions = vehicles.map(v => ({x: v.position.x, y: v.position.y}));
            const minX = Math.min(...positions.map(p => p.x));
            const maxX = Math.max(...positions.map(p => p.x));
            const minY = Math.min(...positions.map(p => p.y));
            const maxY = Math.max(...positions.map(p => p.y));
            
            const rangeX = maxX - minX || 100;
            const rangeY = maxY - minY || 100;
            const padding = 40;
            
            // Transform coordinates
            function toCanvas(x, y) {
                return {
                    x: padding + ((x - minX) / rangeX) * (canvas.width - 2 * padding),
                    y: canvas.height - (padding + ((y - minY) / rangeY) * (canvas.height - 2 * padding))
                };
            }
            
            // Draw vehicles
            vehicles.forEach(v => {
                const pos = toCanvas(v.position.x, v.position.y);
                const isEgo = v.vehicle_id === 0;
                
                // Draw vehicle
                ctx.beginPath();
                ctx.arc(pos.x, pos.y, isEgo ? 10 : 6, 0, 2 * Math.PI);
                ctx.fillStyle = isEgo ? '#ef4444' : '#4ade80';
                ctx.fill();
                
                // Draw ID
                ctx.fillStyle = 'white';
                ctx.font = '10px sans-serif';
                ctx.fillText(v.vehicle_id, pos.x + 12, pos.y + 4);
            });
            
            // Draw connections for ego vehicle
            const ego = vehicles.find(v => v.vehicle_id === 0);
            if (ego) {
                const egoPos = toCanvas(ego.position.x, ego.position.y);
                vehicles.forEach(v => {
                    if (v.vehicle_id !== 0) {
                        const vPos = toCanvas(v.position.x, v.position.y);
                        const dist = Math.sqrt(
                            Math.pow(v.position.x - ego.position.x, 2) + 
                            Math.pow(v.position.y - ego.position.y, 2)
                        );
                        
                        // Only draw if within V2V range (assume 75m)
                        if (dist <= 75) {
                            ctx.beginPath();
                            ctx.moveTo(egoPos.x, egoPos.y);
                            ctx.lineTo(vPos.x, vPos.y);
                            ctx.strokeStyle = 'rgba(74, 222, 128, 0.3)';
                            ctx.lineWidth = 2;
                            ctx.stroke();
                        }
                    }
                });
            }
        }
        
        // Initialize
        connect();
        
        // Refresh data periodically
        setInterval(() => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                fetchNetworkStats();
                updateEgoInfo();
                fetchNeighbors();
                fetchThreats();
            }
        }, 1000);
    </script>
</body>
</html>
